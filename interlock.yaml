version: '3.4'

services:
  visualizer:
    image: dockersamples/visualizer:stable
    deploy:
      placement:
        constraints: [node.role == manager]
    ports:
      - "8081:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"

  haproxy: &haproxy
    image: haproxy
    ports:
      - 80:80
      - 443:443
      - 8000:8000
      - 8443:8443
      - 1936:1936
    depends_on:
        - interlock
    volumes:
      - my-haproxy:/usr/local/etc/haproxy/

  interlock:
    image: ehazlett/interlock:master
    command: run -c /etc/interlock/config.toml
    volumes:
        - "$PWD/data/interlock/config.toml:/etc/interlock/config.toml"
        - "$PWD/data/interlock/haproxy.cfg.template:/usr/local/etc/interlock/haproxy.cfg.template"
        - "/var/run/docker.sock:/var/run/docker.sock"

volumes:
  my-haproxy:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: $PWD/data/haproxy/
